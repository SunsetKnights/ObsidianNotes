### 计算机网络体系结构
##### 几种交换方式的优缺点
- 电路交换
	- 优点：通信时延小、有序传输、没有冲突、实时性强
	- 缺点：建立连接时间长、链路利用率低、灵活性差、难以实现差错控制
- 报文交换
	- 优点：无建立连接时延、灵活分配线路、线路利用率高、支持差错控制
	- 缺点：转发时延高、缓存开销大、错误处理低效
- 分组交换
	- 优点：存储转发开销小、传输效率高、出错概率和重传代价小
	- 缺点：存在存储转发时延、需要额外的信息量、可能出现分组丢失，失序等情况
##### OSI模型
1. 物理层：规定了电路接口的一些参数，比如机械形状、尺寸、引脚的数量和排列等，以及传输的信号意义和电气特征
2. 数据链路层：点对点的通信，实现封装成帧、差错控制和流量控制
3. 网络层：主机对主机的通信，实现流量控制、拥塞控制、差错控制和网际互连
4. 传输层：进程对进程的通信，实现流量控制、差错控制、建立和释放连接、可靠传输管理等服务，**OSI的传输层仅提供有连接的可靠服务**
5. 会话层：管理主机之间的会话进程，插入同步点以维持可靠会话
6. 表示层：处理不同主机中交换信息的表示方式，以及数据压缩、加密、解密等
7. 应用层：用户与网络的接口
##### TCP/IP模型
1. 网络接口层：对应OSI模型的物理层和数据链路层
2. 网际层：对应OSI模型的网络层，使用IP协议
3. 传输层：对应OSI模型的传输层，TCP和UDP，注意OSI的传输层只提供有连接可靠服务
4. 应用层：对应OSI模型的最上三层，HTTP、SMTP、DNS等等
### 物理层
##### 一些概念
- 码元：一个固定时长的信号波形表示一个k进制数据，称为一个码元
- 码元传输速率：又叫波特率或者调制速率，表示每秒传输的码元数，单位Baud
- 信息传输速率：又叫比特率，单位b/s
- 奈奎斯特定理：对于**无噪声信道**，信息传输的速率最大为：$2W\log_2V$，其中W表示信道频率带宽，2W是波特率，$\log_2V$表示每个码元携带的信息量
- 香农定理：有噪声信道的极限传输速率为：$\displaystyle W\log_2\left(1+\frac SN\right)$，其中W仍然表示信道频率带宽，S为信道的平均功率，N为信道的高斯噪声功率，这里的S/N是无单位记法，可以直接参与运算，如果是分贝记法，要除以10然后作为10的指数，例如，如果是40dB，那么对应的$\displaystyle\frac SN=10^{\frac{40}{10}}=10000$
##### 编码
- 非归零码（NRZ）：高1低0
- 归零码（RZ）：高1第0，中间跳零
- 反向非归零码（NRZI）：码元开头有跳变表示0，无跳变表示1
- 曼彻斯特码（**以太网**）：码元中间从上到下跳变为1，从下到上为0（电平跳变既作为数据，又作为时钟）
- 差分曼彻斯特码：开头不跳变为1，跳变为0（电平跳变仅作为时钟）
##### 调制
- 调频（AM）：用有振幅和无振幅表示0和1
- 调频（FM或FSK）：通过不同频率表示0和1
- 调相（PM或PSK）：通过不同相位表示0和1，比如sin函数0-2pi的图像和pi-2pi的图像
##### 物理层的接口特性
1. 机械特性：接口的形状和尺寸、引脚数量和排列、固定和锁定装置等
2. 电气特性：电压范围，传输速率和距离限制等
3. 功能特性：每条线的功能，以及某条线上某个电压的意义
4. 过程特性：各种事件出现的顺序
##### 物理层设备
- 中继器：**信号再生**，不能连接不同速率和协议的网络，但可以连接不同介质的网络，10BASE5规范中最多5段线，4个中继器，3台计算机
- 集线器：半双工设备
##### 各种传输方式
- 基带传输：直接传输数字信号
- 频带传输：把数字信号调制成模拟信号传输
- 宽带传输：用频带传输把链路分解成多个信道
### 数据链路层
##### HDLC协议
- 用01111110（连续的6个1）界定帧，所以数据中每当遇到5个连续的1，就在后面插入一个0
##### 检错编码
- 奇偶校验码：在数据的最末尾插入一个bit，使得整段数据中1出现的次数为奇数或偶数
- CRC：生成多项式若是n次，则位串长度是n+1，计算时，在原始数据后面补上n个0，得到n位余数，附加在原始数据后面
##### 海明码
- 检错d位需要码距d+1，纠错d位需要2d+1
- 设数据有n位，检验位有k位，k需满足：$2^k\geqslant n+k+1$
- 检验位和数据位放在一起，检验位的位置是从后往前数的第1、2、4、8……位，其余是数据位，检验位的取值是，所有需要该检验位表示的数据位异或，比如第三位是数据位，3=1+2，那么这两个检验位计算的时候都需要第三位参与
##### 滑动窗口协议
- 注意帧编号是n位时，SR和GBN协议的发送窗口和接收窗口大小限制：$2^n\geqslant W_R+W_T$
- 一定要注意对于GBN和SR来说，虽然发送窗口小于$2^n-1$，但帧编号还是$0\sim 2^n-1$
- 数据链路层的滑动窗口协议，窗口大小是固定的，注意跟传输层的做出区别
- ARQ（自动重传）使用确认和超时重传机制，停等，GBN和SR都是ARQ协议，其中GBN和SR又叫连续ARQ协议
- 注意GBN的累积确认机制和TCP的不同，GBN确认n时，表示n和n之前的都收到了，但是TCP确认n时，表示期待收到n，n之前的都收到了
- SR协议检测到错误会发送NAK
- 信道利用率：$\displaystyle U=\frac{nT_D}{T_D+RTT+T_A}$，其中，$T_D$表示发送时延，$T_A$表示确认时延
##### 信道划分
- 时分复用（TDM），把信道划分时间片，每个用户占用固定序号的时隙
- 频分复用（FDM），把信道划分为多个子频带
- 波分复用（WDM），光的频分复用
- 码分复用（CDM），每个站点分配一个码片，每个站点的码片相互正交，站点要发送1时，发送自己的码片，发送0时，发送码片的反码，所有站点的码片在信道中线性相加，之后目的站把收到的数据与每个站点的码片做点积运算，就可以知道每个站点发送的数据
##### ALOHA协议
- 纯ALOHA：想发就发，收不到确认就等待随机时间再次发送
- 时隙ALOHA：只能在每个时隙开始时发送数据
##### CSMA协议
- 非坚持CSMA：信道忙时放弃监听，等待一个随机时间再监听
- 1-坚持CSMA：要发送数据时，坚持监听信道，监听到空闲时，立即发送，立即发送的概率是1
- p-坚持CSMA：只适用于时分信道，要发送数据时，坚持监听信道（每个时隙都监听），空闲时，以p的概率立即发送数据
##### CSMA/CD协议
- 先听后发，边听边发，冲突停发，随即重发
- 以太网的最短帧长是64B，对于10Mb/s以太网来说，争用期是51.2μs，而对于100Mb/s的以太网来说，争用期就变成了5.12μs，换句话说，**最短帧长不变，争用期变**
- 若第k次重传不成功，则随机$0\sim2^k-1$倍的争用期之后重传，k最大是10，之后不再改变，当16此重传仍然失败，停止重传并报错
##### CSMA/CA
- 用于无线网络，收到一帧的确认才重传下一帧
- 帧间间隔：
	- SIFS（最短），分隔一次会话的各帧
	- PIFS（中等长度），PCF方式中使用
	- DIFS（最长），DCF方式中使用
- 检测到信道空闲时，先等待一个DIFS，之后如果不是第一个帧，就等待一个随机退避时间以再次试图访问信道，若是第一个帧，不需要等待，第k次退避时，随机退避$0\sim 2^{2+k}-1$个时隙，k在第六次退避时不再增加，最大退避时间是255个时隙，注意这里的退避时隙是指退避空闲时隙，如果检测到信道忙，退避时隙计数器不减
- 信道预约：
	- 源站检测到信道空闲，等待DIFS，发送RTS，其中RTS中的预约时间是SIFS+CTS+SIFS+DATA+SIFS+ACK的时间
	- AP收到RTS，若允许发送，则等待一个SIFS，广播CTS，其中CTS中的时间是SIFS+DATA+SIFS+ACK
	- **信道预约不是强制规定**
##### MAC
- 检验码要检验除前导码之外的整个帧
##### VLAN
- VLAN增加了4字节的标识，使以太网帧的最小长度从46B变成42B，最大长度从1518B变成1522B
- 使用VLAN时，A向B发送一个帧时，交换机转发的几种情况：
	- 若A和B在同一个VLAN，且连接到同一个交换机，则直接转发
	- 若A和B在同一个VLAN，但连接到不同的交换机，那么A连接的交换机会在A发出的标准以太网帧中插入VLAN标签，变成一个802.11Q帧，之后转交给B连接的交换机，B连接的交换机删除VLAN标签，之后交付给B一个标准的以太网帧
	- 若A和B不在同一个VLAN，那么需要交由路由器转发
##### PPP协议
- PPP协议由以下几个部分组成：
	1. 链路控制协议（LCP）：用来建立、测试、配置数据链路连接
	2. 网络控制协议（NCP）：为网络层协议配置和建立逻辑连接（每个网络层协议都有一个相应的NCP）
	3. 把IP数据报封装到串行链路的方法
- 工作过程：链路静止（无链路）、链路建立（物理链路）、鉴别（LCP链路）、网络层协议（已经鉴别的LCP链路）、链路打开（已鉴别的LCP链路和NCP链路）
- PPP帧长是整数字节、PPP是**有连接不可靠**服务、PPP用CRC检验但不纠正错误
##### 交换机和集线器
- 交换机：全双工、并行、自学习、交换速率高
- 集线器无论收到什么帧，都从除收到这个帧的端口外广播这个帧
- 交换机和集线器在广播帧时（交换机在没有转发表时），都是把该帧送到除接收该帧端口以外的所有端口
- 集线器是物理层设备
### 网络层
##### 数据服务和虚电路服务

|           |            数据报服务            |         虚电路服务          |
| :-------: | :-------------------------: | :--------------------: |
| 是否需要建立连接  |             不需要             |          必须要           |
|   目的地址    |        每个分组携带完整的目的地址        | 在建立虚电路时使用完整地址，之后只用VCID |
|   路由选择    |        每个分组独立的进行路由选择        |      所有分组按照同一路由转发      |
|   分组顺序    |          不保证分组有序到达          |        保证分组有序到达        |
|    可靠性    |             不可靠             |           可靠           |
| 对网络故障的适应性 | 故障的节点分组丢失，其他分组可以通过其他节点到达目的地 |    所有经过故障节点的虚电路均不可用    |
| 差错控制和流量控制 |    由主机进行流量控制，不保证数据报的可靠性     |    可由网络负责，也可由用户主机负责    |
##### IPv4
- 首部有固定的20B长度，可扩展，但总长度是4B的倍数
- 版本：4bit，表示IP协议的版本，IPv4的此字段值为4
- 首部长度：4bit，单位是4B，最常用的值是5，即20B固定首部
- 总长度：16bit，单位是1B
- 标识：16bit，用于区分分片后是哪个IP数据包
- 标志：3bit，MF（More Fragment）=1表示后面还有分片，DF（Don't Fragment）=0表示允许分片
- 片偏移：13bit，单位是8B
- TTL：8bit，路由器转发数据包前，先把TTL-1，如果-1之后为0，则丢弃
- 协议：8bit，6表示TCP，17表示UDP
- 首部校验和：16bit，只检验数据报的首部
- IP分片在**目的地网络层**被组装
##### IPv4地址
- A、B、C类地址的网络号长度分别是8、16、24，前几位固定为0、10、110，D类地址作为多播地址，前几位固定为1110，E类保留，前几位固定为1111
- 主机号全0和全1表示网络地址和广播地址
- 127.x.x.x作为环回地址
- 全0表示本主机
- 全1表示受限广播地址，仅在本网络进行广播，若路由器收到此地址，不会进行转发
- 三块私有地址：10.0.0.0~10.255.255.255、172.16.0.0~172.31.255.255、192.168.0.0~192.168.255.255
##### NAT (Network Address Translation)
- NAT由于能看到端口，所以工作在传输层
- 下面是一些NAT中的私有地址
	- 10.0.0.0/8，即10.0.0.0~10.255.255.255
	- 172.16.0.0/12，即172.16.0.0~172.31.255.255
	- 192.168.0.0/16，即192.168.0.0~192.168.255.255
##### 两类特殊的路由表项
- 子网掩码为255.255.255.255，表示对某个ip地址单独指定一个路由
- **0.0.0.0/0**，默认路由
##### ARP (Address Resolution Protocol)协议
- 用于解析**同一局域网中**IP和MAC对应关系的协议，每台**主机**都有ARP缓存
- 若初始时ARP缓存都为空，那么A向B发送数据时，先**广播（FF-FF-FF-FF-FF-FF）一个ARP请求**分组，B收到后单播一个ARP相应分组，分组中包含B的IP和MAC
- 分组在跨网络传播时，每个路由器都会重新封装MAC帧
##### DHCP (Dynamic Host Configuration Protocol)协议
- 动态主机配置协议，**应用层**协议，基于**UDP**
- 4个步骤
	1. DHCP发现（源：0.0.0.0；目的：255.255.255.255）
	2. DHCP提供（源：DHCP服务器地址；目的：255.255.255.255）
	3. DHCP请求（源：0.0.0.0；目的：255.255.255.255）
	4. DHCP确认（源：DHCP服务器地址；目的：255.255.255.255）
- 注意DHCP提供报文虽然网络层是广播地址，但数据链路层是单播地址
##### ICMP (Internet Control Message Protocol)协议
- 封装在IP数据包中，是网络层协议
- ICMP差错报文：
	- 终点不可达
	- 源点抑制
	- 时间超过
	- 参数问题
	- 改变路由（重定向）
- ICMP询问报文
	- 回送请求和回答报文：测试目的主机是否可达
	- 时间戳请求和回答报文：测试RTT
##### IPv6
- 提供扩展首部，但首部长度固定40B，扩展的部分不算在首部长度，路由器也不处理
- 自动配置，无需DHCP
- 支持资源预分配
- 只有源主机才能分片
##### RIP (Routing Information Protocol)协议
- 是一种距离向量路由选择算法，内部网关协议（IGP）的一种
- 距离=16表示不可达，仅和相邻网络交换信息、交换本路由器所知的全部信息、每间隔固定时间交换一次信息，若经过超时时间没有收到相邻节点发来的路由表，设为不可达
- 使用UDP传送数据
- 实现简单，开销小，收敛快，坏消息传播的慢，好消息传播的快
##### OSPF (Open Shortest Path First)协议
- 是一种链路状态路由选择算法，内部网关协议（IGP）的一种
- 使用洪泛法，向所有路由器发送与本路由器相连的其他路由器链路信息，之后收到信息的路由器继续从所有端口发送这个信息，但不包含收到信息的端口，链路状态变化时才洪泛发送信息
- 使用IP数据报传送信息
- 分组类型：问候分组、数据库描述分组、链路状态请求分组、链路状态更新分组、链路状态确认分组
##### BGP (Border Gateway Protocol)协议
- 是一种路径向量路由选择协议，基于TCP
- 自治AS之间用外部BGP会话，自治AS之内用内部BGP会话
- 选择BGP路由时，首先选择本地偏好最高的路由，其次选择AS跳数最少的路由，最后选择AS内部跳数最少的路由
- BGP报文：
	- Open：与BGP对等方建立关系
	- Update：通知路由信息
	- Keepalive：证实临站连通性
	- Notification：发送检测到的差错
##### IP多播
 - 多播地址就是D类地址
 - 多播是尽力交付，不产生ICMP差错报文
 - MAC地址中，01-00-5E-00-00-00~01-00-5E-7F-FF-FF中的后23位用于多播
### 传输层
##### UDP
- UDP首部
	- 源端口：4B，不需要时可全为0
	- 目的端口号：4B
	- 长度：UDP数据报的长度，最小值是8
	- 检验和：注意区分与IP检验和的区别，IP仅校验首部，UDP校验整个数据包
	- 在校验时要添加一个12B的伪首部，按16位二进制反码计算，接收方收到之后同样补上伪首部，然后算校验和，如果结果为全1，则表明没有差错
- 二进制反码求和：正常相加，最高位有进位时，把进位1加到最低位，最终得到的结果取反
- 如果UDP检测到数据包错误，可以丢弃，也可以交付给上层，但要附上错误报告
##### TCP首部
- 源端口和目的端口：各2B
- 序号：4B，注意TCP是给每个字节编号
- 确认号：4B，注意确认的序号是期待收到的序号，且采用累计确认
- 数据偏移：4bit，表示有效数据相对于整个数据包的偏移，说白了就是首部长度，单位是4B，最小值是5，和IP数据包一样，表示首部至少20B
- 保留：6bit
- URG（紧急）、ACK、PSH（不用等缓存满，直接推送给上层）、RST、SYN（建立连接时使用）、FIN
- 窗口：2B，表示从本确认号开始还有多少接收窗口
- 检验和：2B，计算方式和UDP一样
- 紧急指针：2B，在URG=1时才有意义，指出数据段最前面的紧急数据的长度
##### 三次握手和四次挥手
- 三次握手
	1. Client to Server，SYN=1，ACK=0，seq=x，这步消耗一个序号
	2. Server to Client，SYN=1，ACK=1，seq=y，ack=x+1
	3. Client to Server，ACK=1，seq=x+1，ack=y+1，这一步可以传输数据，若不携带数据，这步不消耗序号
- 三次握手时，客户和服务器的状态变化如下
	- 客户端：CLOSE、SYN_SENT、ESTABLISHED
	- 服务端：LISTENING、SYN_RCVD、ESTABLISHED
- 四次挥手
	1. Client to Server，FIN=1，seq=u，这步消耗一个序号
	2. Server to Client，ACK=1，seq=v，ack=u+1，此时客户端不能向服务端发送数据，但服务端还可以向客户端发送数据
	3. Server to Client，FIN=1，ACK=1，seq=w，ack=u+1
	4. Client to Server，ACK=1，seq=u+1，ack=w+1
- 四次挥手时，客户和服务器的状态变化如下
	- 客户端：ESTABLISHED、FIN_WAIT1、FIN_WAIT2、TIME_WAIT、CLOSED
	- 服务端：ESTABLISHED、CLOSE_WAIT、LAST_ACK、CLOSED
- 从客户端发出SYN开始，客户端至少需要1RTT+2MSL完全关闭，服务端至少需要1.5RTT
##### 拥塞控制和流量控制
- 拥塞控制是指减轻网络负载（拥塞窗口），流量控制是控制端到端的流量（接收窗口）
- 流量控制：当接收窗口为0时，发送发启动一个持续计时器，超时时探测接收窗口 
- 拥塞控制：
	- 慢开始：每收到一个ACK，拥塞窗口+1，一个RTT翻一倍，直到门限
	- 拥塞避免：每个RTT，拥塞窗口+1
	- 连续收到三个冗余ACK，拥塞窗口和门限同时变为当前拥塞窗口的一半
	- 超时，门限变为当前拥塞窗口的一半，拥塞窗口变为1
- 发送窗口=拥塞窗口
### 应用层
##### DNS
- 四级域名服务器：根域名服务器、顶级域名服务器、权限域名服务器、本地域名服务器
- 主机向本地域名服务器查询的过程使用递归查询，本地域名服务器向其他域名服务器用递归或者迭代查询
- DNS基于UDP协议
##### FTP
- 带外控制，控制端口21，数据端口20，使用TCP
##### 邮件
- SMTP：基于推的协议，可用于电子邮件服务器之间互相发送邮件， 或者用户UA向服务器推送邮件，端口号25
- POP3：基于拉的协议，用于把电子邮件服务器上的邮件拉到本地
- MIME：SMTP的扩展，SMTP只能发送ASCII，所以MIME把所有东西都编码成ASCII
- IMAP：强化的POP3
##### HTTP
- HTTP1.0默认非持久连接，1.1默认持久连接，有流水方式和非流水方式
- 要注意，流水线方式是针对URL对象的流水线，比如请求三个图像，那么可以同时发出请求，但是，如果是一个图像的大小是n个MSS，那么就不能同时请求